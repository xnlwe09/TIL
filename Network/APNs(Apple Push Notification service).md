# APNs(Apple Push Notification service)

## APNs(Apple Push Notification service)란?

**Apple이 제공하는 푸시 알림 전송 서비스**

## APNs 기본 개념

- 푸시 서버와 기기(클라이언트(디바이스/앱)) 사이의 중개자 역할을 함
- 개발자가 직접 디바이스로 푸시를 보내는 게 아니라 항상 APNs를 통해서 전달됨
- 보안, 효율, 네트워크 최적화, 배터리 절약을 위해 애플이 중앙에서 관리

## APNs의 역할

<aside>

### 📍알림 전달

- 전원 On : 서버(Provider)가 보낸 알림은 APNs를 거쳐 즉시 기기로 전달됨
- 전원 Off (또는 네트워크가 끊겼을 때) :
    - APNs가 메세지를 큐에 보관하고 있다가 기기가 다시 연결되면 전달
    - But 모든 알림을 다 전달해주진 않고 가장 최근 알림 하나만 전달하는 경우가 많음
    - 그리고 너무 오랫동안 오프라인 상태면 APNs가 큐에서 자동으로 알림을 삭제
    
    그래서 푸시 알림은 데이터 보관용도가 아니라 서버가 기기랑 앱을 깨우는 트리거 역할로만 쓰는 거라함
    
</aside>

<aside>

### 📍보안

푸시 서버에서 APNs에 암호화하여 알림을 보내게 됨

→ APNs만 암호화된 내용을 해독할 수 있고 외부에서의 알림 가로챔과 수정을 방지하기 위해서

</aside>

## 동작 순서

<aside>

1. **토큰 발급**
    - 앱이 APNs에 푸시 받겠다는 요청을 보내면(디바이스 토큰 요청) APNs가
        
        앱을 구분할 수 있는 디바이스 토큰(device token)을 발급
        
2. **서버에 토큰 전달**
    - 앱은 APNs에서 받은 디바이스 토큰을 서버에 전달
3. **푸시 메세지 생성 & 전송**
    - 서버가 푸시를 보내고 싶을 때, JSON payload(알림 내용), 디바이스 토큰을 APNs에 보냄
4. **APNs가 디바이스에 전달**
    - 디바이스 토큰을 확인한 후 전달받은 알림을 기기로 보냄
    - 디바이스가 꺼져 있거나 오프라인이면 일정 시간 큐에 저장해놨다가 디바이스가 연결되면 전달
</aside>